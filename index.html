<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunucu Log Görüntüleyici</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Log satırları için yeni ve geliştirilmiş stiller */
        .log-line { 
            white-space: pre-wrap; 
            word-break: break-all; 
            padding: 4px 12px;
            border-left: 4px solid transparent; /* Varsayılan olarak şeffaf kenarlık */
            transition: background-color 0.2s ease;
        }
        .log-line:hover {
            background-color: rgba(255, 255, 255, 0.05); /* Üzerine gelince hafif parlama */
        }

        /* Durumlara göre renk ve kenarlık atamaları */
        .log-line.error { 
            border-left-color: #ef4444; /* Kırmızı */
            color: #fca5a5; 
        }
        .log-line.warn { 
            border-left-color: #f59e0b; /* Sarı */
            color: #fcd34d; 
        }
        .log-line.info { 
            border-left-color: #3b82f6; /* Mavi */
            color: #93c5fd; 
        }
        .log-line.success { 
            border-left-color: #22c55e; /* Yeşil */
            color: #86efac; 
        }
        .log-line.debug { 
            border-left-color: #a855f7; /* Mor */
            color: #d8b4fe; 
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-6xl mx-auto p-4 md:p-6">
        <!-- 1. Bağlantı Ekranı -->
        <div id="connection-screen" class="max-w-md mx-auto">
            <div class="bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 border border-gray-700">
                <div class="text-center mb-6">
                    <i class="fas fa-server text-4xl text-blue-400 mb-3"></i>
                    <h1 class="text-2xl font-bold text-white">Sunucuya Bağlan</h1>
                    <p class="text-gray-400 mt-1">İzlemek istediğiniz sunucunun SSH bilgilerini girin.</p>
                </div>
                <form id="connect-form">
                    <div class="mb-4">
                        <label for="ip" class="block text-sm font-medium text-gray-300 mb-2">Sunucu IP Adresi</label>
                        <input type="text" id="ip" name="ip" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="192.168.1.1" required>
                    </div>
                    <div class="mb-4">
                        <label for="user" class="block text-sm font-medium text-gray-300 mb-2">Kullanıcı Adı</label>
                        <input type="text" id="user" name="user" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="root" required>
                    </div>
                    <div class="mb-6">
                        <label for="pass" class="block text-sm font-medium text-gray-300 mb-2">Parola</label>
                        <input type="password" id="pass" name="pass" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <button type="submit" id="connect-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg btn hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        <span id="connect-btn-text">Bağlan</span>
                        <i id="connect-btn-spinner" class="fas fa-spinner fa-spin hidden"></i>
                    </button>
                </form>
                <div id="error-message" class="mt-4 text-red-400 text-sm text-center"></div>
            </div>
        </div>

        <!-- 2. Log Seçim Ekranı -->
        <div id="log-selection-screen" class="hidden">
            <div class="bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 border border-gray-700">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-2xl font-bold text-white">Log Dosyaları</h1>
                        <p class="text-gray-400 mt-1">İzlemek için bir log dosyası seçin.</p>
                    </div>
                    <button id="disconnect-btn-selection" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg btn hover:bg-red-700 text-sm">Bağlantıyı Kes</button>
                </div>
                <div id="log-list-container" class="max-h-96 overflow-y-auto pr-2">
                    <ul id="log-list" class="space-y-2">
                        <!-- Log dosyaları buraya dinamik olarak eklenecek -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- 3. Log Görüntüleyici Ekranı -->
        <div id="log-viewer-screen" class="hidden h-[90vh] flex flex-col">
            <div class="bg-gray-800 rounded-t-xl shadow-lg p-4 border-b border-gray-700 flex flex-wrap justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <button id="back-to-selection-btn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg btn hover:bg-gray-700"><i class="fas fa-arrow-left mr-2"></i>Geri</button>
                    <div>
                        <p class="text-xs text-gray-400">Sunucu: <span id="server-ip-display" class="font-semibold text-gray-200"></span></p>
                        <p class="text-xs text-gray-400">İzlenen Dosya: <span id="log-file-display" class="font-semibold text-gray-200"></span></p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <i class="fas fa-search text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                        <input type="text" id="filter-input" placeholder="Loglarda ara..." class="bg-gray-700 border border-gray-600 rounded-lg pl-10 pr-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-64">
                    </div>
                    <button id="toggle-stream-btn" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg btn hover:bg-yellow-600" data-status="running">
                        <i class="fas fa-pause mr-2"></i><span>Durdur</span>
                    </button>
                    <button id="disconnect-btn-viewer" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg btn hover:bg-red-700">Bağlantıyı Kes</button>
                </div>
            </div>
            <div id="log-container" class="bg-gray-900 rounded-b-xl flex-grow overflow-y-auto p-4 font-mono text-sm leading-6">
                <!-- Loglar buraya gelecek -->
            </div>
        </div>
    </div>

    <script>
        const backendUrl = 'http://localhost:3000';

        // Element Referansları
        const screens = {
            connection: document.getElementById('connection-screen'),
            selection: document.getElementById('log-selection-screen'),
            viewer: document.getElementById('log-viewer-screen'),
        };
        const connectForm = document.getElementById('connect-form');
        const connectBtn = document.getElementById('connect-btn');
        const connectBtnText = document.getElementById('connect-btn-text');
        const connectBtnSpinner = document.getElementById('connect-btn-spinner');
        const errorMessage = document.getElementById('error-message');
        
        const logList = document.getElementById('log-list');
        const logContainer = document.getElementById('log-container');
        const filterInput = document.getElementById('filter-input');
        const toggleStreamBtn = document.getElementById('toggle-stream-btn');
        
        const backToSelectionBtn = document.getElementById('back-to-selection-btn');
        const disconnectBtnSelection = document.getElementById('disconnect-btn-selection');
        const disconnectBtnViewer = document.getElementById('disconnect-btn-viewer');

        const serverIpDisplay = document.getElementById('server-ip-display');
        const logFileDisplay = document.getElementById('log-file-display');

        // Global Değişkenler
        let logSocket = null;
        let isStreamPaused = false;

        // --- YARDIMCI FONKSİYONLAR ---

        function switchScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            if (screens[screenName]) {
                screens[screenName].classList.remove('hidden');
            }
        }
        
        function showError(message) {
            errorMessage.textContent = message;
        }

        function setLoading(isLoading) {
            connectBtn.disabled = isLoading;
            connectBtnSpinner.classList.toggle('hidden', !isLoading);
            connectBtnText.classList.toggle('hidden', isLoading);
            connectBtnText.textContent = isLoading ? '' : 'Bağlan';
        }

        // --- API & WEBSOCKET İŞLEMLERİ ---

        connectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(connectForm);
            const data = Object.fromEntries(formData.entries());
            
            showError('');
            setLoading(true);

            try {
                const response = await fetch(`${backendUrl}/connect`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });

                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || 'Bilinmeyen bir hata oluştu.');
                }
                
                await fetchLogFiles();
                serverIpDisplay.textContent = data.ip;

            } catch (error) {
                showError(`Bağlanılamadı: ${error.message}`);
            } finally {
                setLoading(false);
            }
        });

        async function fetchLogFiles() {
            try {
                const response = await fetch(`${backendUrl}/list-logs`);
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Log dosyaları alınamadı.');
                }
                
                logList.innerHTML = '';
                if (result.files.length === 0) {
                    logList.innerHTML = `<li class="text-gray-400">İzlenecek .log uzantılı dosya bulunamadı.</li>`;
                } else {
                    result.files.forEach(file => {
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center bg-gray-700 p-3 rounded-lg';
                        li.innerHTML = `
                            <span class="font-mono text-blue-300"><i class="fas fa-file-alt mr-3 text-gray-400"></i>${file}</span>
                            <button data-filename="${file}" class="watch-btn bg-green-600 text-white font-bold py-1 px-3 rounded-md btn text-sm hover:bg-green-700">İzle</button>
                        `;
                        logList.appendChild(li);
                    });
                }
                switchScreen('selection');

            } catch (error) {
                showError(`Hata: ${error.message}`);
                switchScreen('connection');
            }
        }
        
        logList.addEventListener('click', (e) => {
            if (e.target.classList.contains('watch-btn')) {
                const logFile = e.target.dataset.filename;
                startLogStream(logFile);
            }
        });

        function startLogStream(logFile) {
            logContainer.innerHTML = `<div class="text-yellow-400">"${logFile}" için log akışı bekleniyor...</div>`;
            logFileDisplay.textContent = logFile;
            isStreamPaused = false;
            updateToggleStreamButton();
            switchScreen('viewer');

            if (logSocket) logSocket.close();

            logSocket = new WebSocket(`ws://${backendUrl.replace('http://', '')}`);

            logSocket.onopen = () => {
                console.log('WebSocket bağlantısı kuruldu.');
                logSocket.send(logFile);
            };

            logSocket.onmessage = (event) => {
                if (!isStreamPaused) {
                    appendLog(event.data);
                }
            };

            logSocket.onerror = (error) => {
                console.error('WebSocket Hatası:', error);
                appendLog(`\n--- HATA: WebSocket bağlantı hatası. ---`, 'error');
            };
            
            logSocket.onclose = () => {
                console.log('WebSocket bağlantısı kapandı.');
                if(!isStreamPaused) {
                   appendLog(`\n--- UYARI: Sunucu ile log akış bağlantısı kesildi. ---`, 'warn');
                }
            };
        }

        async function disconnectFromServer() {
            if (logSocket) {
                logSocket.close();
                logSocket = null;
            }
            try {
                await fetch(`${backendUrl}/disconnect`, { method: 'POST' });
            } catch (error) {
                console.error('Disconnect hatası:', error.message);
            } finally {
                switchScreen('connection');
                connectForm.reset();
                showError('');
            }
        }

        disconnectBtnSelection.addEventListener('click', disconnectFromServer);
        disconnectBtnViewer.addEventListener('click', disconnectFromServer);
        
        backToSelectionBtn.addEventListener('click', () => {
            if (logSocket) {
                logSocket.close();
                logSocket = null;
            }
            switchScreen('selection');
        });

        // --- LOG GÖRÜNTÜLEYİCİ İŞLEVLERİ ---

        function appendLog(logText, type) {
            if (logContainer.children.length === 1 && logContainer.firstChild.textContent.includes('bekleniyor')) {
                logContainer.innerHTML = '';
            }
            
            const lines = logText.split('\n').filter(Boolean);
            lines.forEach(line => {
                const logLine = document.createElement('div');
                logLine.className = 'log-line';
                logLine.textContent = line;
                
                // Renklendirme mantığı burada, JavaScript'te değişiklik yok.
                // Sadece CSS'i güncelledik.
                const lowerLine = line.toLowerCase();
                if (type === 'error' || lowerLine.includes('error') || lowerLine.includes('failed')) {
                    logLine.classList.add('error');
                } else if (type === 'warn' || lowerLine.includes('warn')) {
                    logLine.classList.add('warn');
                } else if (lowerLine.includes('info')) {
                    logLine.classList.add('info');
                } else if (lowerLine.includes('success') || lowerLine.includes('ok')) {
                    logLine.classList.add('success');
                } else if (lowerLine.includes('debug')) {
                    logLine.classList.add('debug');
                }
                
                logContainer.appendChild(logLine);
            });

            logContainer.scrollTop = logContainer.scrollHeight;
        }

        filterInput.addEventListener('input', () => {
            const filterText = filterInput.value.toLowerCase();
            const lines = logContainer.getElementsByClassName('log-line');
            for (let line of lines) {
                if (line.textContent.toLowerCase().includes(filterText)) {
                    line.style.display = '';
                } else {
                    line.style.display = 'none';
                }
            }
        });

        function updateToggleStreamButton() {
            const icon = toggleStreamBtn.querySelector('i');
            const text = toggleStreamBtn.querySelector('span');
            if (isStreamPaused) {
                toggleStreamBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                toggleStreamBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                icon.className = 'fas fa-play mr-2';
                text.textContent = 'Başlat';
                toggleStreamBtn.dataset.status = 'paused';
            } else {
                toggleStreamBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                toggleStreamBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                icon.className = 'fas fa-pause mr-2';
                text.textContent = 'Durdur';
                toggleStreamBtn.dataset.status = 'running';
            }
        }

        toggleStreamBtn.addEventListener('click', () => {
            isStreamPaused = !isStreamPaused;
            updateToggleStreamButton();
        });

        switchScreen('connection');
    </script>
</body>
</html>

